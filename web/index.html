<!doctype html>
<head>
<script>
        document.getElementById("command").addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                handleSubmit();
            }
        });
        document.addEventListener('keydown', function (e) {
            // Ctrl keys seem to only work with keydown
            // TODO: Only if currently running a command
            if (e.key === 'c' && e.ctrlKey) {
                handleCancel();
            }
        });
        document.getElementById("log").addEventListener("dblclick", function(e) {
            for (let el of e.composedPath().reverse()) {
                if (el.nodeName === "DETAILS") {
                    el.open = !el.open;
                    break;
                }
            }
        })

    function handleSubmit() {
        const commandEl = document.getElementById("command");
        const command = commandEl.value;
        if (!command) {
            return false
        }

        let wrapper = createLogElement(command);

        commandEl.value = "";
        commandEl.disabled = true;
        let json;
        try {
            const resp = await fetch("/run", {
                method: "POST",
                body: command,
            });
            json = await resp.json();
        } catch (error) {
            console.error(error);
            commandEl.disabled = false;
            return false
        }
        return false
    }
    
    function handleComplete() {
        const commandEl = document.getElementById("command");
        const command = commandEl.value;
        if (!command) {
            return false
        }

        let wrapper = createLogElement(command);

        //commandEl.value = "";
        //commandEl.disabled = true;
        let json;
        try {
            const resp = await fetch("/complete", {
                method: "POST",
                body: command,
            });
            json = await resp.json();
        } catch (error) {
            console.error(error);
            //commandEl.disabled = false;
            return false
        }

        updateCompletionElement(wrapper, json);

        //document.getElementById("dir").textContent = json.Dir

        //commandEl.disabled = false;
        //commandEl.focus()
        //document.scrollingElement.scrollTop = document.scrollingElement.scrollHeight;
        return false
    }

    function createLogElement(command) {
        // Yuck
        const logEl = document.getElementById("log");
        let wrapperEl = document.createElement("details");

        const summaryEl = document.createElement("summary");
        let codeEl = document.createElement("code");
        logEl.append(wrapperEl);
        wrapperEl.append(summaryEl);
        summaryEl.append(codeEl);
        codeEl.textContent = command;

        return wrapperEl;
    }

    function createCompletionElement(command) {
        // Yuck
        const logEl = document.getElementById("completion");
        logEl.innerHTML = "";
        let wrapperEl = document.createElement("details");

        const summaryEl = document.createElement("summary");
        let codeEl = document.createElement("code");
        logEl.append(wrapperEl);
        wrapperEl.append(summaryEl);
        summaryEl.append(codeEl);
        codeEl.textContent = command;

        return wrapperEl;
    }

    function updateLogElement(wrapper, resp) {
        wrapper.open = true;
        if (resp.Err) {
            wrapper.className = "failed";
        }

        function addHtml(className, value) {
            if (value) {
                let div = document.createElement("div");
                div.classList.add("term-container");
                div.classList.add(className);
                div.innerHTML = value;
                wrapper.append(div);
            }
        }
        function addPre(className, value) {
            if (value) {
                let pre = document.createElement("pre");
                pre.className = className;
                pre.textContent = value;
                wrapper.append(pre);
            }
        }
        addHtml("stdout", resp.Stdout)
        addPre("stderr", resp.Stderr)
        addPre("err", resp.Err && resp.Err.Text)
        console.log(resp);
    }

    function updateCompletionElement(wrapper, resp) {
        wrapper.open = true;
        if (resp.Err) {
            wrapper.className = "failed";
        }

        function addHtml(className, value) {
            if (value) {
                // TODO: for-loop each elem
                let div = document.createElement("div");
                div.classList.add("completion-container");
                div.classList.add(className);
                div.innerHTML = value;
                wrapper.append(div);
            }
        }
        function addPre(className, value) {
            if (value) {
                let pre = document.createElement("pre");
                pre.className = className;
                pre.textContent = value;
                wrapper.append(pre);
            }
        }
        addHtml("stdout", resp.Stdout)
        addPre("stderr", resp.Stderr)
        addPre("err", resp.Err && resp.Err.Text)
        console.log(resp);
    }
    
    function handleCancel() {
        await fetch("/cancel", {
            method: "POST",
        });
    }
</script>
<link href="terminal.css" rel="stylesheet">
<style>
    details.failed {
        background: lavenderblush;
    }
    details pre {
        margin-left: 1.5em;
    }
    .term-container {
        margin: 1em 0 1em 1.5em;
    }
    summary code,
    .stdin {
        color: green;
    }
    .stderr {
        color: red;
    }
    .err {
        color: olive;
    }
    #command {
        height: 100px;
        width: 90%;
    }
</style>
</head>
<body>
    <div id="log"></div>
    <div id="dir"></div>
    <form id="prompt">
        <textarea name="command" id="command"></textarea>
        <button type="submit" onClick="handleSubmit()">Run</button>
        <button type="submit" onclick="handleComplete()">Complete</button>
    </form>
    <div id="completion"></div>
</body>
